databaseChangeLog:
  - changeSet:
      id: 006-criar-tabela-usuario-roles
      author: sistema
      comment: "Suporte a múltiplas roles por usuário"
      changes:
        - createTable:
            tableName: usuario_roles
            columns:
              - column:
                  name: usuario_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: role
                  type: VARCHAR(20)
                  constraints:
                    nullable: false
        
        - addPrimaryKey:
            tableName: usuario_roles
            columnNames: usuario_id, role
            constraintName: pk_usuario_roles
        
        - addForeignKeyConstraint:
            baseTableName: usuario_roles
            baseColumnNames: usuario_id
            referencedTableName: usuarios
            referencedColumnNames: id
            constraintName: fk_usuario_roles_usuario
            onDelete: CASCADE

  - changeSet:
      id: 006-migrar-roles-existentes
      author: sistema
      comment: "Migrar roles existentes para nova tabela"
      changes:
        - sql:
            sql: |
              INSERT INTO usuario_roles (usuario_id, role)
              SELECT id, role FROM usuarios WHERE role IS NOT NULL;

  - changeSet:
      id: 006-adicionar-role-ativa
      author: sistema
      comment: "Adicionar campo role_ativa para contexto de sessão"
      changes:
        - addColumn:
            tableName: usuarios
            columns:
              - column:
                  name: role_ativa
                  type: VARCHAR(20)
                  remarks: "Role atualmente ativa na sessão do usuário"

  - changeSet:
      id: 006-preencher-role-ativa
      author: sistema
      comment: "Preencher role_ativa com a role atual"
      changes:
        - sql:
            sql: |
              UPDATE usuarios SET role_ativa = role WHERE role IS NOT NULL;

  - changeSet:
      id: 006-remover-coluna-role
      author: sistema
      comment: "Remover coluna role antiga (agora está em usuario_roles)"
      changes:
        - dropColumn:
            tableName: usuarios
            columnName: role
