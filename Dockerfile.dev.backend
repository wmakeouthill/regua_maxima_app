# ================================================
# Dockerfile para Backend em Desenvolvimento
# Hot-reload com Spring Boot DevTools
# Java 21 LTS com Virtual Threads
# ================================================

FROM eclipse-temurin:21-jdk

# Instalar Maven
RUN apt-get update && apt-get install -y maven && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copiar pom.xml primeiro para aproveitar cache de dependências
COPY backend/pom.xml ./pom.xml
COPY backend/kernel-compartilhado/pom.xml ./kernel-compartilhado/pom.xml
COPY backend/autenticacao/pom.xml ./autenticacao/pom.xml
COPY backend/sistema-orquestrador/pom.xml ./sistema-orquestrador/pom.xml

# Download de dependências (cached)
RUN mvn dependency:go-offline -B || true

# Copiar código fonte
COPY backend/ .

# Porta da aplicação + debug
EXPOSE 8080 5005

# Script para hot-reload automático
# Monitora mudanças usando polling (compatível com Windows + Docker volumes)
# Criando o script diretamente com printf para evitar problemas de encoding
RUN printf '#!/bin/sh\n\
# Script para monitorar mudanças e recompilar automaticamente com DevTools\n\
\n\
# Compilar uma vez antes de iniciar\n\
echo "Compilando projeto inicial..."\n\
mvn install -DskipTests -q\n\
\n\
# Criar trigger file inicial e arquivo de controle\n\
touch /app/sistema-orquestrador/.reloadtrigger\n\
touch /tmp/last_check\n\
\n\
# Iniciar Spring Boot em background\n\
echo "Iniciando Spring Boot com DevTools..."\n\
mvn spring-boot:run -pl sistema-orquestrador \\\n\
  -Dspring-boot.run.jvmArguments="-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 -XX:+UseZGC -XX:+ZGenerational" \\\n\
  -Dspring-boot.run.profiles=dev \\\n\
  -Dspring-boot.run.fork=false &\n\
SPRING_PID=$!\n\
\n\
# Função para verificar e recompilar se necessário\n\
check_and_recompile() {\n\
  # Verificar se há arquivos .java modificados desde a última verificação\n\
  if find /app -name "*.java" -type f -newer /tmp/last_check 2>/dev/null | grep -q .; then\n\
    echo "[$(date +%%H:%%M:%%S)] Mudanças detectadas, recompilando..."\n\
    mvn compile -DskipTests -q\n\
    if [ $? -eq 0 ]; then\n\
      # Tocar o trigger file para forçar restart do DevTools\n\
      touch /app/sistema-orquestrador/.reloadtrigger\n\
      echo "[$(date +%%H:%%M:%%S)] Recompilação concluída, DevTools irá reiniciar..."\n\
    fi\n\
    touch /tmp/last_check\n\
  fi\n\
}\n\
\n\
# Monitorar mudanças nos arquivos Java (polling a cada 2 segundos)\n\
echo "Monitorando mudanças nos arquivos Java (polling a cada 2s)..."\n\
while kill -0 $SPRING_PID 2>/dev/null; do\n\
  check_and_recompile\n\
  sleep 2\n\
done\n\
\n\
echo "Spring Boot parou."\n' > /app/watch-and-run.sh && \
    chmod +x /app/watch-and-run.sh && \
    chmod 755 /app/watch-and-run.sh && \
    test -f /app/watch-and-run.sh && \
    test -x /app/watch-and-run.sh && \
    head -1 /app/watch-and-run.sh | grep -q '^#!/bin/sh' || (echo "Erro: script não criado corretamente" && exit 1)

# Sobrescrever completamente o entrypoint do eclipse-temurin
# O entrypoint padrão (/__cacert_entrypoint.sh) está causando problemas de execução
ENTRYPOINT ["/bin/sh"]
CMD ["/app/watch-and-run.sh"]
