<ion-header>
    <ion-toolbar color="primary">
        <ion-title>Barbeiros</ion-title>
        <ion-buttons slot="end">
            <ion-button>
                <ion-icon name="notifications-outline" slot="icon-only"></ion-icon>
            </ion-button>
        </ion-buttons>
    </ion-toolbar>

    <ion-toolbar color="primary">
        <ion-searchbar
            [(ngModel)]="termoBusca"
            (ionInput)="buscar()"
            placeholder="Buscar barbeiros..."
            debounce="300"
        ></ion-searchbar>
    </ion-toolbar>
</ion-header>

<ion-content>
    <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
        <ion-refresher-content></ion-refresher-content>
    </ion-refresher>

    <!-- Localização atual -->
    <div class="location-bar">
        <ion-icon name="location-outline"></ion-icon>
        <span>{{ localizacaoAtual() }}</span>
        <ion-button fill="clear" size="small" (click)="alterarLocalizacao()">Alterar</ion-button>
    </div>

    <!-- Erro de localização -->
    @if (erroLocalizacao()) {
        <div class="location-error">
            <ion-icon name="location-outline" color="warning"></ion-icon>
            <span>{{ erroLocalizacao() }}</span>
        </div>
    }

    <!-- Seletor Lista/Mapa -->
    <div class="view-toggle">
        <ion-segment [(ngModel)]="tipoVisualizacao" (ionChange)="alterarVisualizacao()">
            <ion-segment-button value="lista">
                <ion-icon name="list-outline"></ion-icon>
                <ion-label>Lista</ion-label>
            </ion-segment-button>
            <ion-segment-button value="mapa">
                <ion-icon name="map-outline"></ion-icon>
                <ion-label>Mapa</ion-label>
            </ion-segment-button>
        </ion-segment>
    </div>

    @if (carregando()) {
        <!-- Skeleton loading -->
        <div class="skeleton-list">
            @for (i of [1,2,3]; track i) {
                <ion-card>
                    <ion-card-content>
                        <div class="skeleton-card">
                            <ion-skeleton-text [animated]="true" style="width: 80px; height: 80px; border-radius: 50%;"></ion-skeleton-text>
                            <div class="skeleton-info">
                                <ion-skeleton-text [animated]="true" style="width: 60%; height: 20px;"></ion-skeleton-text>
                                <ion-skeleton-text [animated]="true" style="width: 80%; height: 16px;"></ion-skeleton-text>
                                <ion-skeleton-text [animated]="true" style="width: 40%; height: 16px;"></ion-skeleton-text>
                            </div>
                        </div>
                    </ion-card-content>
                </ion-card>
            }
        </div>
    } @else if (tipoVisualizacao === 'mapa') {
        <!-- Placeholder do Mapa -->
        <div class="map-placeholder">
            <ion-icon name="map-outline"></ion-icon>
            <h3>Mapa de Barbeiros</h3>
            <p>Integração com Google Maps em breve</p>
            <ion-button fill="outline" (click)="tipoVisualizacao = 'lista'">
                Ver em Lista
            </ion-button>
        </div>
    } @else if (barbeirosFiltrados().length === 0) {
        <ion-card class="empty-card">
            <ion-card-content>
                <ion-icon name="person-outline"></ion-icon>
                <h4>Nenhum barbeiro encontrado</h4>
                <p>Não há barbeiros próximos à sua localização ou tente buscar com outros termos</p>
            </ion-card-content>
        </ion-card>
    } @else {
        <!-- Lista de Barbeiros -->
        <div class="barbeiros-list">
            @for (barbeiro of barbeirosFiltrados(); track barbeiro.id) {
                <ion-card (click)="abrirBarbeiro(barbeiro)" button>
                    <ion-card-content>
                        <div class="barbeiro-card">
                            <!-- Foto -->
                            <div class="barbeiro-foto">
                                @if (barbeiro.fotoUrl) {
                                    <img [src]="barbeiro.fotoUrl" [alt]="barbeiro.nome" />
                                } @else {
                                    <div class="foto-placeholder">
                                        <ion-icon name="person-outline"></ion-icon>
                                    </div>
                                }
                                @if (barbeiro.vinculado && barbeiro.barbeariaNome) {
                                    <ion-badge color="tertiary" class="vinculo-badge">Barbearia</ion-badge>
                                } @else {
                                    <ion-badge color="medium" class="vinculo-badge">Autônomo</ion-badge>
                                }
                            </div>

                            <!-- Info -->
                            <div class="barbeiro-info">
                                <div class="barbeiro-header">
                                    <h3>{{ barbeiro.nome }}</h3>
                                    <ion-button 
                                        fill="clear" 
                                        size="small" 
                                        (click)="toggleFavorito(barbeiro, $event)"
                                    >
                                        <ion-icon 
                                            [name]="barbeiro.favorito ? 'heart' : 'heart-outline'"
                                            [color]="barbeiro.favorito ? 'danger' : 'medium'"
                                            slot="icon-only"
                                        ></ion-icon>
                                    </ion-button>
                                </div>

                                @if (barbeiro.barbeariaNome) {
                                    <p class="barbearia-nome">
                                        <ion-icon name="storefront-outline"></ion-icon>
                                        {{ barbeiro.barbeariaNome }}
                                    </p>
                                }

                                <div class="barbeiro-meta">
                                    @if (barbeiro.distanciaKm !== undefined) {
                                        <span class="distancia">
                                            <ion-icon name="navigate-outline"></ion-icon>
                                            {{ barbeiro.distanciaKm | number:'1.1-1' }} km
                                        </span>
                                    }
                                    @if (barbeiro.totalAvaliacoes > 0) {
                                        <span class="avaliacao">
                                            <ion-icon name="star-outline" color="warning"></ion-icon>
                                            {{ barbeiro.avaliacaoMedia | number:'1.1-1' }}
                                            <small>({{ barbeiro.totalAvaliacoes }})</small>
                                        </span>
                                    }
                                </div>

                                @if (barbeiro.especialidades) {
                                    <ion-chip size="small" color="secondary">
                                        {{ barbeiro.especialidades | slice:0:30 }}@if(barbeiro.especialidades.length > 30) {...}
                                    </ion-chip>
                                }
                            </div>

                            <ion-icon name="chevron-forward-outline" class="arrow"></ion-icon>
                        </div>
                    </ion-card-content>
                </ion-card>
            }
        </div>
    }
</ion-content>
