<ion-header class="explorar-header">
    <ion-toolbar>
        <ion-title>Barbearias</ion-title>
        <ion-buttons slot="end">
            <ion-button>
                <ion-icon name="notifications-outline" slot="icon-only"></ion-icon>
            </ion-button>
        </ion-buttons>
    </ion-toolbar>

    <ion-toolbar>
        <ion-searchbar [(ngModel)]="termoBusca" (ionInput)="buscar()" placeholder="Buscar barbearias..."
            debounce="300"></ion-searchbar>
    </ion-toolbar>
</ion-header>

<ion-content class="explorar-content">
    <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
        <ion-refresher-content></ion-refresher-content>
    </ion-refresher>

    <!-- Localização atual -->
    <div class="location-bar">
        <ion-icon name="location-outline"></ion-icon>
        <span>{{ localizacaoAtual() }}</span>
        <ion-button fill="clear" size="small" (click)="alterarLocalizacao()">Alterar</ion-button>
    </div>

    <!-- Erro de localização -->
    @if (erroLocalizacao()) {
    <div class="location-error">
        <ion-icon name="location-outline" color="warning"></ion-icon>
        <span>{{ erroLocalizacao() }}</span>
    </div>
    }

    <!-- Seletor Lista/Mapa -->
    <div class="view-toggle">
        <ion-segment [(ngModel)]="tipoVisualizacao" (ionChange)="alterarVisualizacao()">
            <ion-segment-button value="lista">
                <ion-icon name="list-outline"></ion-icon>
                <ion-label>Lista</ion-label>
            </ion-segment-button>
            <ion-segment-button value="mapa">
                <ion-icon name="map-outline"></ion-icon>
                <ion-label>Mapa</ion-label>
            </ion-segment-button>
        </ion-segment>
    </div>

    @if (carregando()) {
    <!-- Skeleton loading -->
    <div class="skeleton-list">
        @for (i of [1,2,3]; track i) {
        <ion-card>
            <ion-card-content>
                <div class="skeleton-card">
                    <ion-skeleton-text [animated]="true"
                        style="width: 90px; height: 90px; border-radius: 12px;"></ion-skeleton-text>
                    <div class="skeleton-info">
                        <ion-skeleton-text [animated]="true" style="width: 70%; height: 20px;"></ion-skeleton-text>
                        <ion-skeleton-text [animated]="true" style="width: 90%; height: 16px;"></ion-skeleton-text>
                        <ion-skeleton-text [animated]="true" style="width: 50%; height: 16px;"></ion-skeleton-text>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>
        }
    </div>
    } @else if (tipoVisualizacao === 'mapa') {
    <!-- Placeholder do Mapa -->
    <div class="map-container" style="height: calc(100vh - 200px); width: 100%;">
        <app-mapa [center]="mapCenter()" [markers]="mapMarkers()" [zoom]="14" height="100%"
            (markerClick)="onMapMarkerClick($event)"></app-mapa>
    </div>
    } @else if (barbeariasFiltradas().length === 0) {
    <ion-card class="empty-card">
        <ion-card-content>
            <ion-icon name="storefront-outline"></ion-icon>
            <h4>Nenhuma barbearia encontrada</h4>
            <p>Não há barbearias próximas à sua localização ou tente buscar com outros termos</p>
        </ion-card-content>
    </ion-card>
    } @else {
    <!-- Lista de Barbearias -->
    <div class="barbearias-list">
        @for (barbearia of barbeariasFiltradas(); track barbearia.id) {
        <ion-card (click)="abrirBarbearia(barbearia)" button class="barbearia-card-wrapper">
            <ion-card-content>
                <div class="barbearia-card">
                    <!-- Foto da Barbearia -->
                    <div class="barbearia-foto">
                        @if (barbearia.fotoUrl) {
                        <img [src]="barbearia.fotoUrl" [alt]="barbearia.nome" />
                        } @else {
                        <div class="foto-placeholder">
                            <ion-icon name="storefront-outline"></ion-icon>
                        </div>
                        }
                        @if (barbearia.ativo) {
                        <ion-badge color="success" class="status-badge">Aberta</ion-badge>
                        } @else {
                        <ion-badge color="medium" class="status-badge">Fechada</ion-badge>
                        }
                    </div>

                    <!-- Info da Barbearia -->
                    <div class="barbearia-info">
                        <div class="barbearia-header">
                            <h3>{{ barbearia.nome }}</h3>
                            <ion-button fill="clear" size="small" (click)="toggleFavorito(barbearia, $event)">
                                <ion-icon [name]="barbearia.favorito ? 'heart' : 'heart-outline'"
                                    [color]="barbearia.favorito ? 'danger' : 'medium'" slot="icon-only"></ion-icon>
                            </ion-button>
                        </div>

                        <p class="endereco">
                            <ion-icon name="location-outline"></ion-icon>
                            {{ barbearia.endereco }}
                            @if(barbearia.bairro) {, {{ barbearia.bairro }}}
                            @if(barbearia.cidade) { - {{ barbearia.cidade }}}
                            @if(barbearia.estado) {/{{ barbearia.estado }}}
                        </p>

                        <div class="barbearia-meta">
                            @if (barbearia.distanciaKm !== undefined && barbearia.distanciaKm > 0) {
                            <span class="distancia">
                                <ion-icon name="navigate-outline"></ion-icon>
                                {{ barbearia.distanciaKm | number:'1.1-1' }} km
                            </span>
                            }
                            @if (barbearia.avaliacaoMedia > 0) {
                            <span class="avaliacao">
                                <ion-icon name="star-outline" color="warning"></ion-icon>
                                {{ barbearia.avaliacaoMedia | number:'1.1-1' }}
                                <small>({{ barbearia.totalAvaliacoes }})</small>
                            </span>
                            }
                        </div>

                        <!-- Quantidade de barbeiros -->
                        @if (barbearia.quantidadeBarbeiros && barbearia.quantidadeBarbeiros > 0) {
                        <div class="barbearia-extras">
                            <ion-chip size="small" color="tertiary">
                                <ion-icon name="people-outline"></ion-icon>
                                <ion-label>{{ barbearia.quantidadeBarbeiros }} barbeiro@if(barbearia.quantidadeBarbeiros
                                    > 1){s}</ion-label>
                            </ion-chip>
                        </div>
                        }
                    </div>

                    <ion-icon name="chevron-forward-outline" class="arrow"></ion-icon>
                </div>
            </ion-card-content>
        </ion-card>
        }
    </div>
    }
</ion-content>