<ion-header>
    <ion-toolbar color="primary">
        <ion-title>Fila de Atendimentos</ion-title>
        <ion-buttons slot="end">
            <ion-button (click)="recarregar()">
                <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
            </ion-button>
        </ion-buttons>
    </ion-toolbar>
</ion-header>

<ion-content>
    <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
        <ion-refresher-content></ion-refresher-content>
    </ion-refresher>

    <!-- Stats Resumo -->
    <div class="stats-row">
        <div class="stat-item">
            <span class="stat-value">{{ quantidadeAguardando() }}</span>
            <span class="stat-label">Aguardando</span>
        </div>
        <div class="stat-item">
            <span class="stat-value">{{ emAtendimento() ? 1 : 0 }}</span>
            <span class="stat-label">Em Atendimento</span>
        </div>
        <div class="stat-item">
            <span class="stat-value">{{ quantidadeHoje() }}</span>
            <span class="stat-label">Hoje</span>
        </div>
    </div>

    <!-- Sem Permissão (role errada) -->
    @if (semPermissao()) {
        <ion-card class="empty-card info-card">
            <ion-card-content>
                <ion-icon name="swap-horizontal-outline" color="primary"></ion-icon>
                <h4>Acesso como Dono de Barbearia</h4>
                <p>Para gerenciar a fila, você precisa estar logado com o perfil de Dono de Barbearia ou Barbeiro.</p>
                <ion-button fill="outline" routerLink="/selecionar-perfil">
                    <ion-icon name="swap-horizontal-outline" slot="start"></ion-icon>
                    Trocar Perfil
                </ion-button>
            </ion-card-content>
        </ion-card>
    } @else if (cadastroIncompleto()) {
        <!-- Perfil de Barbeiro não configurado -->
        <ion-card class="empty-card warning-card">
            <ion-card-content>
                <ion-icon name="cut-outline" color="warning"></ion-icon>
                <h4>Configure seu Perfil de Barbeiro</h4>
                <p>Para gerenciar a fila de atendimentos, você precisa configurar seu perfil de barbeiro.</p>
                <ion-button fill="outline" routerLink="/tabs/admin/meu-perfil-barbeiro">
                    <ion-icon name="person-add-outline" slot="start"></ion-icon>
                    Configurar Perfil
                </ion-button>
            </ion-card-content>
        </ion-card>
    } @else if (erro()) {
        <!-- Erro Real -->
        <ion-card class="empty-card error-card">
            <ion-card-content>
                <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
                <h4>Erro ao carregar fila</h4>
                <p>{{ erro() }}</p>
                <ion-button fill="outline" (click)="recarregar()">
                    Tentar novamente
                </ion-button>
            </ion-card-content>
        </ion-card>
    } @else if (carregando()) {
        <div class="loading-container">
            <ion-spinner name="crescent"></ion-spinner>
            <p>Carregando fila...</p>
        </div>
    } @else if (filaEspera().length === 0 && !atendimentoAtual()) {
        <!-- Fila Vazia -->
        <ion-card class="empty-card">
            <ion-card-content>
                <ion-icon name="person-outline" color="medium"></ion-icon>
                <h4>Nenhum cliente na fila</h4>
                <p>A fila está vazia. Quando clientes chegarem, eles aparecerão aqui automaticamente.</p>
            </ion-card-content>
        </ion-card>
    } @else {
        <!-- Em Atendimento -->
        @if (atendimentoAtual(); as atual) {
            <div class="section-header">
                <h3>Em Atendimento</h3>
            </div>
            <ion-list>
                <ion-item>
                    <ion-avatar slot="start">
                        <div class="avatar-placeholder avatar-active">
                            <ion-icon name="cut-outline"></ion-icon>
                        </div>
                    </ion-avatar>
                    <ion-label>
                        <h2>{{ atual.cliente.nome }}</h2>
                        <p>{{ atual.servico.nome }} - {{ atual.servico.duracaoMinutos }} min</p>
                        <p class="hora-chegada">
                            <ion-icon name="time-outline"></ion-icon>
                            Iniciado às {{ atual.horaInicioAtendimento }}
                        </p>
                    </ion-label>
                    <ion-button slot="end" fill="outline" color="success" (click)="finalizarAtendimento(atual)">
                        <ion-icon name="checkmark-circle-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                </ion-item>
            </ion-list>
        }

        <!-- Lista de Aguardando -->
        @if (filaEspera().length > 0) {
            <div class="section-header">
                <h3>Aguardando</h3>
            </div>
            <ion-list>
                @for (atendimento of filaEspera(); track atendimento.id; let i = $index) {
                    <ion-item-sliding>
                        <ion-item>
                            <ion-avatar slot="start">
                                <div class="avatar-placeholder">
                                    <ion-icon name="person-outline"></ion-icon>
                                </div>
                            </ion-avatar>
                            <ion-label>
                                <h2>
                                    <span class="posicao-badge">{{ i + 1 }}º</span>
                                    {{ atendimento.cliente.nome }}
                                </h2>
                                <p>
                                    <ion-icon name="cut-outline"></ion-icon>
                                    {{ atendimento.servico.nome }} - {{ atendimento.servico.duracaoMinutos }} min
                                </p>
                                <p class="hora-chegada">
                                    <ion-icon name="time-outline"></ion-icon>
                                    Esperando há {{ atendimento.tempoEsperaMinutos }} min
                                </p>
                            </ion-label>
                            <ion-chip 
                                slot="end" 
                                [color]="getStatusColor(atendimento.status)"
                            >
                                {{ getStatusLabel(atendimento.status) }}
                            </ion-chip>
                        </ion-item>

                        <ion-item-options side="end">
                            @if (atendimento.status === 'AGUARDANDO' && !emAtendimento()) {
                                <ion-item-option color="primary" (click)="iniciarAtendimento(atendimento)">
                                    <ion-icon name="cut-outline" slot="icon-only"></ion-icon>
                                </ion-item-option>
                            }
                            <ion-item-option color="danger" (click)="cancelarAtendimento(atendimento)">
                                <ion-icon name="close-circle-outline" slot="icon-only"></ion-icon>
                            </ion-item-option>
                        </ion-item-options>
                    </ion-item-sliding>
                }
            </ion-list>
        }
    }
</ion-content>
